name: Build BALLS!!!!
on:
  workflow_dispatch: null
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
permissions:
  contents: read

env:
  CCACHE_DIR: /mnt/ccache
  CCACHE_SLOPPINESS: file_macro,locale,time_macros
  CCACHE_NOHASHDIR: true
  CCACHE_COMPRESS: 1
  CCACHE_COMPRESSLEVEL: 6
  CCACHE_DEPEND: 1
  KBUILD_BUILD_TIMESTAMP: 1970-01-01 00:00:00
  KBUILD_BUILD_VERSION: 1

jobs:
  build_kernel:
    timeout-minutes: 360
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash

    steps:
      - name: ğŸ‘‰ğŸ»ğŸ—‘ï¸ Free Disk Space ğŸ—‘ï¸
        uses: jlumbroso/free-disk-space@main
        with:
          swap-storage: true
          large-packages: true
          tool-cache: false
    
      - name: (ã¥ á´— _á´—)ã¥Checkout repository ğŸ
        uses: actions/checkout@v6
        with:
          fetch-depth: 1
          ref: ck
      
      - name: ğŸ“¦ğŸ“¦ Install build dependencies
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          execute_install_scripts: true
          packages: bc bison build-essential ccache cpio fakeroot flex git kmod libdw-dev libelf-dev libncurses-dev libssl-dev lz4 rsync schedtool wget zstd lld pkg-config devscripts make gcc debhelper debhelper-compat libdw-dev
          version: 1.1
      
      - name: â‹†Ëšê©œï½¡ Set Swap Space
        uses: pierotofy/set-swap-space@master
        with:
          swap-size-gb: 10
      
      - name: ğŸ“‚ Set up CCACHE_DIR mount
        run: |
          sudo mkdir -p /mnt/ccache
          sudo chown -R $USER:$USER /mnt/ccache
          df -h
      
      - name: ğŸƒ Restore CCACHE
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          create-symlink: true
          key: kernel-build-${{ runner.os }}-${{ hashFiles('Makefile', 'arch/*/Makefile',
            '.config') }}
          max-size: 10G
          restore-keys: kernel-build-${{ runner.os }}-
          verbose: 2
      
      - name: ğŸª³ Debug CCACHE Status (Pre-build)
        run: |
          echo "=== PRE-BUILD CCACHE STATUS ==="
          echo "CCACHE_DIR=$CCACHE_DIR"
          ccache -s || true
          which gcc && ls -l "$(which gcc)" || true
          env | grep -i ccache || true
      
      - name: ğŸ”¨ Compile kernel
        run: |
          #make defconfig
          make x86_64_defconfig
          make -j$(($(nproc) + 1)) CC="ccache gcc" CXX="ccache g++" bindeb-pkg
      
      - name: ğŸª² Debug CCACHE (Post-build)
        run: |
          echo "=== POST-BUILD CCACHE STATUS ==="
          ccache -s || true
          du -sh /mnt/ccache || true
      
      - name: ğŸ§¹ Cleanup useless DEB files
        run: |
          rm -f ../*dbg*.deb ../*libc-dev*.deb || true
          ls -lh ../*.deb

      - name: â¬†ï¸ Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          compression-level: 6
          retention-days: 30
          name: ck-kernel-deb-pkgs
          path: ../*.deb
          if-no-files-found: error
          
